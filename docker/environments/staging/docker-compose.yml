version: '3.4'
services:
    # MySQL Database
    # mysql_db_staging: 
    #   image: mysql:8.0
    #   restart: always
    #   environment:
    #     MYSQL_ALLOW_EMPTY_PASSWORD: true
    #   ports:
    #     - "3316:3306"
    #   volumes:
    #     - /db_volumes/mysql_data_staging:/var/lib/mysql
    
    # MongoDB Database
    mongo_db_staging:
      image: mongo:5.0
      env_file:
        - /home/ubuntu/code/.env_mongo
      restart: always
      ports:
        - "27027:27017"
      volumes:
        - /db_volumes/mongo_data_staging:/data/db
  
    # Redis Database
    redis_db_staging:
      image: redis:latest
      restart: always
      ports:
        - "6389:6379"
      volumes:
        - /db_volumes/redis_data_staging:/data
      command: redis-server --bind 0.0.0.0
    
    # chatCDP https://github.com/munishgandhi/chatCDP 
    chatcdp_staging: 
      image: us-east1-docker.pkg.dev/gds-prototype-20190629/ml-staging/chatcdp:latest
      env_file:
        - /home/ubuntu/code/.env.chatcdp_stg
      deploy:
        restart_policy:
          condition: on-failure
          delay: 5s
          max_attempts: 3
        resources:
          limits:
            cpus: '0.30'
            memory: 1g
      ports:
        - "5001:5000"
      depends_on:
        - redis_db_staging

    # chatCDP services https://github.com/munishgandhi/JAI.GPT.LeaseGPT.MailGPT/tree/main/ChatCDP
    chatcdp_services_staging: 
      image: us-east1-docker.pkg.dev/gds-prototype-20190629/ml-staging/chatcdp-services:latest
      env_file:
        - /home/ubuntu/code/.env.chatcdp_services_stg
      deploy:
        restart_policy:
          condition: on-failure
          delay: 5s
          max_attempts: 3
        resources:
          limits:
            cpus: '0.30'
            memory: 1g
      ports:
        - "5011:5000"

    hayleygpt_staging: 
      image: us-east1-docker.pkg.dev/gds-prototype-20190629/ml-staging/hayleygpt:latest
      env_file:
        - /home/ubuntu/code/.env.hayleygpt_stg
      deploy:
        restart_policy:
          condition: on-failure
          delay: 5s
          max_attempts: 3
        resources:
          limits:
            cpus: '0.30'
            memory: 1g
      ports: 
        - "5006:5000"
      depends_on:
        - mongo_db_staging

    #https://github.com/munishgandhi/etl-hub/tree/datascience_stg
    pai_datascience_services_staging: 
      image: us-east1-docker.pkg.dev/gds-prototype-20190629/ml-staging/pai-datascience-services:latest
      deploy:
        restart_policy:
          condition: on-failure
          delay: 5s
          max_attempts: 3
        resources:
          limits:
            cpus: '0.30'
            memory: 1g
      ports: 
        - "82:80"
  
    # etl_hub_staging:
    #   image: us-east1-docker.pkg.dev/gds-prototype-20190629/ml-staging/etl-hub:latest
    #   deploy:
    #     restart_policy:
    #       condition: on-failure
    #       delay: 5s
    #       max_attempts: 3

    #     resources:
    #       limits:
    #         cpus: '0.25'
    #         memory: 350M
    #   ports:
    #     - "3001:3000"
   
volumes:
  # mysql_data_staging:
  #   external: true
  mongo_data_staging:
    external: true
  redis_data_staging:
    external: true
    
networks:
  default:
    name: microservices_staging
    external: true